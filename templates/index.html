<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Tibetan Debate Trainer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Title font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --maroon:#7A0019; --yellow:#FFD34E; --bg:#FFF8EA; --ink:#2a2a2a;
      --card:#ffffff; --muted:#6b6b6b; --ring: rgba(122,0,25,0.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--ink); background:linear-gradient(180deg, var(--bg), #fff);
      overflow-x:hidden;
    }

    .sidebar{position:fixed; top:0; bottom:0; width:88px; display:flex; align-items:center; justify-content:center; opacity:.38; z-index:1; pointer-events:none; padding:8px 0; background:linear-gradient(180deg, transparent 0%, rgba(255,240,210,.22) 40%, transparent 100%);}
    .sidebar .inner{height:100%; width:100%; display:grid; grid-template-rows: repeat(8, min-content); align-content:space-evenly; justify-items:center}
    .sidebar svg{width:64px; height:64px; display:block; filter: drop-shadow(0 1px 0 rgba(122,0,25,.15)) drop-shadow(0 0 6px rgba(255,211,78,.25));}
    .sidebar.left{left:0} .sidebar.right{right:0}

    .app{position:relative; z-index:2; max-width: 1000px; margin: 32px auto; padding: 0 16px 96px;}
    header{background: var(--maroon); color: #fff; border-radius: 16px; padding: 22px 24px; box-shadow: 0 12px 24px rgba(0,0,0,0.12); display:flex; align-items:center; justify-content:center; gap:12px;}
    header h1{margin:0; font-size: clamp(26px, 3.6vw, 38px); letter-spacing:.4px; font-family: "Cinzel", serif; text-shadow: 0 1px 0 rgba(0,0,0,.15);}

    .card{background: var(--card); border-radius: 16px; padding: 18px; box-shadow: 0 8px 18px rgba(0,0,0,0.08); border:1px solid #f1e7d5; margin-top:16px;}
    .row{display:grid; grid-template-columns: 1fr 140px 1fr; gap:10px; align-items:center}
    .row + .row{margin-top:10px}
    .label{font-weight:700; color:var(--maroon)}
    .pill{display:inline-block; background: #fef7da; color:#5a3100; border:1px solid #ffe08a; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:700;}
    .subtle{color:var(--muted); font-size:14px}
    .hint{font-size:13px; color:#7b6a55}
    .stack{display:grid; gap:10px}
    .stack-sm{display:grid; gap:6px}
    .legend{font-size:13px; color:#583; margin-top:2px}

    input[type="text"], textarea, select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e0d6c4; background:#fff; color:var(--ink); outline:none;}
    textarea{min-height:70px; resize:vertical}
    select:focus, input[type="text"]:focus, textarea:focus{border-color: var(--yellow); box-shadow:0 0 0 4px var(--ring);}

    .turnbar{
      position:fixed; left:0; right:0; bottom:0; z-index:5;
      background:rgba(255,255,255,0.96); backdrop-filter: blur(6px);
      border-top:3px solid var(--yellow);
      box-shadow: 0 -10px 24px rgba(0,0,0,.09);
    }
    .turnbar .inner{max-width:1000px; margin:0 auto; padding:12px 16px; display:grid; grid-template-columns: 1fr; gap:10px;}
    .turnbar .who{font-weight:800; color:var(--maroon)}
    .turn-controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .btn{appearance:none; border:none; border-radius:999px; padding:10px 16px; font-weight:700; cursor:pointer; transition:.15s transform ease, .15s filter ease;}
    .btn:active{transform:translateY(1px)}
    .btn-primary{background:var(--maroon); color:#fff}
    .btn-primary:hover{filter:brightness(1.05)}
    .btn-secondary{background:var(--yellow); color:#3a1d00}
    .btn-ghost{background:#fff2; color:var(--maroon); border:1px solid #efdfc6}
    .divider{height:1px; background:#f0e4cf; margin:10px 0}
    .center{text-align:center}

    .venn{border:1px dashed #e6d7bd; border-radius:12px; padding:10px; background:#fffaf0}

    .transcript-box{max-height:50vh; overflow:auto; background:#fff; border:1px solid #f1e7d5; border-radius:12px; padding:10px;}
    #toast{position:fixed; right:20px; bottom:88px; background:var(--maroon); color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 8px 16px rgba(0,0,0,.15); opacity:0; transform:translateY(8px); pointer-events:none; transition:opacity .18s ease, transform .18s ease; z-index:9999;}
    #toast.show{opacity:1; transform:translateY(0);}
  </style>
</head>
<body>

  <aside class="sidebar left" aria-hidden="true"><div class="inner"></div></aside>
  <aside class="sidebar right" aria-hidden="true"><div class="inner"></div></aside>

  <div class="app">
    <header><h1>Tibetan Debate Trainer</h1></header>

    <form id="debateForm" method="post" class="stack" autocomplete="off">
      <input type="hidden" name="step_count" value="{{ step_count }}">
      <!-- Initial orientation only; runtime switches are tracked per-step -->
      <input type="hidden" name="flipped" value="{{ flipped_initial }}">

      <!-- Pre-debate discussion -->
      <div class="card">
        <div class="label">Before you start</div>
        <div class="subtle" style="margin-bottom:6px;">
          Summarize your pre-debate discussion here (optional). This summary appears at the top of the transcript.
        </div>
        <textarea name="preface_text" placeholder="(Optional) Brief summary of the pre-debate discussion…">{{ preface_text }}</textarea>
      </div>

      {% for step in steps %}
        {% set is_current = (loop.index0 == current_idx) %}
        {% set cha_lab = step.cha_label %}
        {% set def_lab = step.def_label %}

        <div class="card" id="step-{{ loop.index0 }}">

          {# Role switch marker card #}
          {% if step.role_switch == '1' %}
            <div class="label">Roles switched</div>
            <div class="hint">From here on: {{ step.switch_to_cha }}; {{ step.switch_to_def }}.</div>
            <!-- Persist marker on postbacks -->
            <input type="hidden" name="role_switch_{{ loop.index0 }}" value="1">
          {% else %}

            {% if not step.subject and not step.predicate and not step.reason %}
              <div class="label">{{ cha_lab }}:</div>
            {% endif %}

            <div class="label subtle">Consequence</div>

            {# Hide in-card consequence inputs only when Turn Panel is active for them AND transcript not showing #}
            {% set hide_consequence_fields = is_current and turn_state.mode == 'new_consequence' and not transcript %}
            {% if not hide_consequence_fields %}
              <div class="row">
                <div>It follows that</div><div></div><div></div>
              </div>
              <div class="row">
                <input type="text" name="subject_{{ loop.index0 }}" value="{{ step.subject }}" placeholder="subject (e.g., sound)" />
                <select name="copula_{{ loop.index0 }}">
                  <option value="is"  {% if step.copula == 'is'  %}selected{% endif %}>is</option>
                  <option value="are" {% if step.copula == 'are' %}selected{% endif %}>are</option>
                </select>
                <input type="text" name="predicate_{{ loop.index0 }}" value="{{ step.predicate }}" placeholder="predicate (e.g., impermanent)" />
              </div>
              {% if not step.reason %}
                <div class="row">
                  <div></div>
                  <div class="subtle center">because of being</div>
                  <input type="text" name="reason_{{ loop.index0 }}" value="{{ step.reason }}" placeholder="reason (optional for first claim)" />
                </div>
              {% else %}
                <div class="row">
                  <div></div><div></div>
                  <input type="text" name="reason_{{ loop.index0 }}" value="{{ step.reason }}" placeholder="reason" />
                </div>
              {% endif %}
            {% else %}
              <div class="hint">Consequence inputs are in the Turn Panel below.</div>
            {% endif %}

            {% if step.consequence %}
              <div class="legend">Preview: <span class="pill">{{ step.consequence }}</span></div>
            {% endif %}

            <div class="divider"></div>

            {# Defender menu: hide here if it's CURRENT defender-choice turn and no transcript #}
            {% set hide_defender_choice = is_current and turn_state.mode == 'defender_choice' and not transcript %}
            {% if step.defender_explanations and not hide_defender_choice %}
              <div class="stack-sm">
                <div class="label">{{ def_lab }}:</div>
                <select class="select-inline" name="defender_choice_{{ loop.index0 }}">
                  <option value="">-- choose --</option>
                  {% for label,ex in step.defender_explanations %}
                    <option value="{{ label }}" {% if step.defender_choice == label %}selected{% endif %}>
                      {{ label }}{% if ex %}  {{ ex }}{% endif %}
                    </option>
                  {% endfor %}
                </select>
                {% if step.defender_choice %}
                  <div class="hint">{{ def_lab }} chose: <strong>{{ step.defender_choice }}</strong></div>
                {% endif %}
              </div>
              <div class="divider"></div>
            {% endif %}

            <!-- Hidden flags that must always post back -->
            <input type="hidden" name="need_reason_{{ loop.index0 }}" value="{{ step.need_reason }}">
            <input type="hidden" name="tsar_called_{{ loop.index0 }}" value="{{ step.tsar_called }}">
            <input type="hidden" name="role_switch_{{ loop.index0 }}" value="0">

            {# "Why?" path #}
            {% set hide_need_reason = is_current and turn_state.mode == 'need_reason' and not transcript %}
            {% if step.need_reason == '1' and not hide_need_reason %}
              <div class="stack-sm">
                <div class="label">{{ cha_lab }} — Complete the reasoning:</div>
                <input type="text" name="challenger_reason_{{ loop.index0 }}" value="{{ step.challenger_reason }}" placeholder="because of being …" />
              </div>
              <div class="divider"></div>
            {% endif %}

            {# Ask flow — persists if Q/A exist #}
            {% set hide_ask_q = is_current and turn_state.mode == 'ask_question' and not transcript %}
            {% set hide_ask_a = is_current and turn_state.mode == 'answer_question' and not transcript %}
            {% if step.challenger_choice == 'Ask a question' or step.question_text or step.answer_text %}
              <div class="stack-sm">
                <div class="label">{{ cha_lab }} — Question:</div>
                {% if not hide_ask_q %}
                  <textarea name="question_text_{{ loop.index0 }}" placeholder="Type your question…">{{ step.question_text }}</textarea>
                {% else %}
                  <div class="hint">Question input is in the Turn Panel below.</div>
                {% endif %}
                {% if step.question_text %}
                  <div class="label">{{ def_lab }} — Answer:</div>
                  {% if not hide_ask_a %}
                    <textarea name="answer_text_{{ loop.index0 }}" placeholder="Type your answer…">{{ step.answer_text }}</textarea>
                  {% else %}
                    <div class="hint">Answer input is in the Turn Panel below.</div>
                  {% endif %}
                {% endif %}
                {% if step.question_text and step.answer_text %}
                  <input type="hidden" name="question_text_{{ loop.index0 }}" value="{{ step.question_text }}">
                  <input type="hidden" name="answer_text_{{ loop.index0 }}" value="{{ step.answer_text }}">
                {% endif %}
              </div>
              <div class="divider"></div>
            {% endif %}

            {# Compare prompt #}
            {% set hide_compare_names = is_current and turn_state.mode == 'compare_names' and not transcript %}
            {% if step.challenger_choice == 'Compare phenomena' and (not step.compare_a or not step.compare_b) and not hide_compare_names %}
              <div class="stack-sm">
                <div class="label">{{ cha_lab }} — Compare</div>
                <div class="subtle">What is the relationship between</div>
                <div class="row">
                  <input type="text" name="compare_a_{{ loop.index0 }}" value="{{ step.compare_a }}" placeholder="term A (e.g., sound)" />
                  <div class="center">and</div>
                  <input type="text" name="compare_b_{{ loop.index0 }}" value="{{ step.compare_b }}" placeholder="term B (e.g., impermanent phenomenon)" />
                </div>
              </div>
              <div class="divider"></div>
            {% endif %}

            {# Compare preview & select #}
            {% set hide_compare_choice = is_current and turn_state.mode == 'compare_choice' and not transcript %}
            {% if (step.compare_a and step.compare_b) and (step.challenger_choice == 'Compare phenomena' or step.compare_locked == '1') and not hide_compare_choice %}
              <div class="stack-sm">
                <div class="label">{{ def_lab }} — Choose diagram:</div>
                <select class="select-inline"
                        id="compare-select-{{ loop.index0 }}"
                        name="compare_option_{{ loop.index0 }}"
                        {% if step.compare_locked == '1' %}disabled{% endif %}>
                  <option value="">-- preview options --</option>
                  {% for opt in ['Mutually inclusive','Mutually exclusive','3 possibilities (down)','3 possibilities (up)','4 possibilities'] %}
                    <option value="{{ opt }}" {% if step.compare_option == opt %}selected{% endif %}>{{ opt }}</option>
                  {% endfor %}
                </select>
                <input type="hidden" name="compare_a_{{ loop.index0 }}" value="{{ step.compare_a }}">
                <input type="hidden" name="compare_b_{{ loop.index0 }}" value="{{ step.compare_b }}">
                {% if step.compare_locked == '1' %}
                  <input type="hidden" name="compare_option_{{ loop.index0 }}" value="{{ step.compare_option }}">
                {% endif %}
                <div class="venn">
                  <div class="subtle">Venn diagram preview</div>
                  <div id="venn-{{ loop.index0 }}"></div>
                  <input type="hidden" name="compare_locked_{{ loop.index0 }}" value="{{ step.compare_locked }}">
                </div>
                {% if step.compare_option %}
                  <div class="hint" style="margin-top:6px;">{{ def_lab }} chose: <strong>{{ step.compare_option }}</strong></div>
                {% endif %}
                <script>
                  (function(){
                    const sel = document.getElementById('compare-select-{{ loop.index0 }}');
                    const box = document.getElementById('venn-{{ loop.index0 }}');
                    const A = {{ step.compare_a|tojson }};
                    const B = {{ step.compare_b|tojson }};
                    function svgWrap(inner){return `<svg width="520" height="320" viewBox="0 0 520 320" xmlns="http://www.w3.org/2000/svg"><rect x="1" y="1" width="518" height="318" rx="16" fill="#fff" stroke="#e7d9bd"/>${inner}</svg>`;}
                    function label(x,y,t,a='middle'){return `<text x="${x}" y="${y}" font-family="system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial" font-size="15" fill="#333" text-anchor="${a}">${t}</text>`;}
                    function render(opt){
                      let svg="";
                      switch(opt){
                        case "Mutually inclusive": {const cx=260,cy=160,r=110; svg=svgWrap(`<circle cx="${cx}" cy="${cy}" r="${r}" fill="#FCE9B3" stroke="#E7C56A"/>${label(cx,cy-85, A+" = "+B)}${label(260,300,"All and only the same members")}`); break;}
                        case "Mutually exclusive": {const r=95,cy=165,l=170,rX=350,g=12; svg=svgWrap(`<circle cx="${l}" cy="${cy}" r="${r}" fill="#FFE2A0" stroke="#E7C56A"/><circle cx="${rX+g}" cy="${cy}" r="${r}" fill="#F6A9A6" stroke="#E7A4A0"/>${label(l,cy,A)}${label(rX+g,cy,B)}${label(260,300,"No overlap")}`); break;}
                        case "3 possibilities (down)": {const cx=260,cy=165,R=120,r=72; svg=svgWrap(`<circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="#E7A4A0" stroke-width="2"/><circle cx="${cx}" cy="${cy}" r="${r}" fill="#FFE2A0" stroke="#E7C56A"/>${label(cx,cy-90,B)}${label(cx,cy,A)}${label(260,300, A+" ⊂ "+B)}`); break;}
                        case "3 possibilities (up)": {const cx=260,cy=165,R=120,r=72; svg=svgWrap(`<circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="#E7C56A" stroke-width="2"/><circle cx="${cx}" cy="${cy}" r="${r}" fill="#F6A9A6" stroke="#E7A4A0"/>${label(cx,cy-90,A)}${label(cx,cy,B)}${label(260,300, B+" ⊂ "+A)}`); break;}
                        case "4 possibilities": {const cy=165,r=95,l=220,rX=300; const lf="#FFE2A0", rf="#F6A9A6", ov="#EFCF95"; svg=svgWrap(`<defs><clipPath id="left-{{ loop.index0 }}"><circle cx="${l}" cy="${cy}" r="${r}"/></clipPath></defs><circle cx="${l}" cy="${cy}" r="${r}" fill="${lf}" stroke="#E7C56A"/><circle cx="${rX}" cy="${cy}" r="${r}" fill="${rf}" stroke="#E7A4A0"/><g clip-path="url(#left-{{ loop.index0 }})"><circle cx="${rX}" cy="${cy}" r="${r}" fill="${ov}"/></g>${label(l-48,cy,A)}${label(rX+48,cy,B)}${label(260,300,"Partial overlap")}`); break;}
                        default: svg=svgWrap(`<text x="260" y="170" font-size="14" fill="#7b6a55" text-anchor="middle">Pick an option to preview…</text>`);
                      }
                      box.innerHTML=svg;
                    }
                    if (sel){ sel.addEventListener('change', e=>render(e.target.value)); render(sel.value); }
                  })();
                </script>
              </div>
              <div class="divider"></div>
            {% endif %}

            {# Tsar path #}
            {% set hide_tsar = is_current and turn_state.mode == 'tsar_decide' and not transcript %}
            {% if step.tsar_called == '1' %}
              <div class="hint">{{ cha_lab }} — Tsar: You contradicted yourself!</div>
            {% endif %}
            {% if step.contradiction_options and not hide_tsar %}
              <div class="stack-sm">
                <div class="label">{{ def_lab }} — Tsar decision:</div>
                <select class="select-inline" name="contradiction_choice_{{ loop.index0 }}">
                  <option value="">-- choose --</option>
                  {% for opt in step.contradiction_options %}
                    <option value="{{ opt }}" {% if step.contradiction_choice == opt %}selected{% endif %}>{{ opt }}</option>
                  {% endfor %}
                </select>
              </div>
            {% endif %}
            {% if step.tsar_called == '1' and step.contradiction_choice %}
              <input type="hidden" name="contradiction_choice_{{ loop.index0 }}" value="{{ step.contradiction_choice }}">
              <div class="hint">{{ def_lab }} — Tsar decision: <strong>{{ step.contradiction_choice }}</strong></div>
              <div class="divider"></div>
            {% endif %}

            {# Challenger menu #}
            {% set hide_challenger_menu = is_current and (turn_state.mode == 'challenger_menu') and not transcript %}
            {% if step.challenger_options and step.need_reason != '1' and not hide_challenger_menu %}
              <div class="stack-sm">
                <div class="label">{{ cha_lab }}:</div>
                <select class="select-inline" name="challenger_choice_{{ loop.index0 }}">
                  <option value="">-- choose --</option>
                  {% for opt in step.challenger_options %}
                    <option value="{{ opt }}" {% if step.challenger_choice == opt %}selected{% endif %}>{{ opt }}</option>
                  {% endfor %}
                </select>
                {% if step.challenger_choice
                      and step.challenger_choice not in ['Ask a question','Compare phenomena','Tsar! [You contradicted yourself!]','Write a new consequence'] %}
                  <div>Complete the reasoning:</div>
                  <input type="text" name="challenger_reason_{{ loop.index0 }}" value="{{ step.challenger_reason }}" placeholder="because of being …" />
                {% endif %}
              </div>
            {% endif %}

          {% endif %}
        </div>
      {% endfor %}

      <!-- BOTTOM BAR: either Transcript view OR Turn Panel -->
      {% if transcript %}
        <div class="turnbar">
          <div class="inner">
            <div class="who">Transcript</div>
            <div class="transcript-box">
              <pre id="transcriptText" style="white-space:pre-wrap; margin:0">{{ transcript }}</pre>
            </div>
            <div class="turn-controls">
              <button class="btn btn-secondary" type="button" onclick="copyTranscript()">Copy transcript</button>
              <button class="btn btn-primary" type="submit" name="close_transcript">Return to game</button>
            </div>
          </div>
        </div>
        <div id="toast" role="status" aria-live="polite">Copied!</div>
      {% else %}
        <div class="turnbar">
          <div class="inner">
            <div class="who">
              {% if turn_state.who == 'challenger' %}{{ current_cha_lab }}{% else %}{{ current_def_lab }}{% endif %}
              — {{ turn_state.label }}
            </div>

            <div class="turn-controls">
              {% set i = current_idx %}
              {% set step = steps[i] %}
              {% set cha_lab = step.cha_label %}
              {% set def_lab = step.def_label %}

              {% if turn_state.mode == 'new_consequence' %}
                <div style="width:100%">
                  <div class="row">
                    <div>It follows that</div><div></div><div></div>
                  </div>
                  <div class="row">
                    <input type="text" name="subject_{{ i }}" value="{{ step.subject }}" placeholder="subject…" />
                    <select name="copula_{{ i }}">
                      <option value="is"  {% if step.copula == 'is'  %}selected{% endif %}>is</option>
                      <option value="are" {% if step.copula == 'are' %}selected{% endif %}>are</option>
                    </select>
                    <input type="text" name="predicate_{{ i }}" value="{{ step.predicate }}" placeholder="predicate…" />
                  </div>
                  <div class="row">
                    <div></div>
                    <div class="subtle center">because of being</div>
                    <input type="text" name="reason_{{ i }}" value="{{ step.reason }}" placeholder="reason (optional for first claim)" />
                  </div>
                </div>
              {% endif %}

              {% if turn_state.mode == 'defender_choice' %}
                <select class="select-inline" name="defender_choice_{{ i }}">
                  <option value="">-- choose --</option>
                  {% for label,ex in step.defender_explanations %}
                    <option value="{{ label }}" {% if step.defender_choice == label %}selected{% endif %}>
                      {{ label }}{% if ex %}  {{ ex }}{% endif %}
                    </option>
                  {% endfor %}
                </select>
              {% endif %}

              {% if turn_state.mode == 'need_reason' %}
                <input type="hidden" name="need_reason_{{ i }}" value="1">
                <input type="text" name="challenger_reason_{{ i }}" value="{{ step.challenger_reason }}" placeholder="because of being …" style="min-width:340px"/>
              {% endif %}

              {% if turn_state.mode == 'ask_question' %}
                <textarea name="question_text_{{ i }}" placeholder="Type your question…" style="min-width:340px">{{ step.question_text }}</textarea>
              {% endif %}

              {% if turn_state.mode == 'answer_question' %}
                <textarea name="answer_text_{{ i }}" placeholder="Type your answer…" style="min-width:340px">{{ step.answer_text }}</textarea>
              {% endif %}

              {% if turn_state.mode == 'compare_names' %}
                <div style="width:100%">
                  <div class="subtle" style="margin-bottom:6px;">What is the relationship between</div>
                  <div class="row" style="width:100%">
                    <input type="text" name="compare_a_{{ i }}" value="{{ step.compare_a }}" placeholder="term A…" />
                    <div class="center">and</div>
                    <input type="text" name="compare_b_{{ i }}" value="{{ step.compare_b }}" placeholder="term B…" />
                  </div>
                </div>
              {% endif %}

              {% if turn_state.mode == 'compare_choice' %}
                <select class="select-inline" id="compare-select-bottom" name="compare_option_{{ i }}">
                  <option value="">-- preview options --</option>
                  {% for opt in ['Mutually inclusive','Mutually exclusive','3 possibilities (down)','3 possibilities (up)','4 possibilities'] %}
                    <option value="{{ opt }}" {% if step.compare_option == opt %}selected{% endif %}>{{ opt }}</option>
                  {% endfor %}
                </select>
                <input type="hidden" name="compare_a_{{ i }}" value="{{ step.compare_a }}">
                <input type="hidden" name="compare_b_{{ i }}" value="{{ step.compare_b }}">
                <div class="venn" style="width:100%">
                  <div class="subtle">Venn diagram preview</div>
                  <div id="venn-bottom"></div>
                </div>

                <script>
                  (function(){
                    const sel = document.getElementById('compare-select-bottom');
                    const box = document.getElementById('venn-bottom');
                    const A = {{ step.compare_a|tojson }};
                    const B = {{ step.compare_b|tojson }};
                    function svgWrap(inner){return `<svg width="520" height="320" viewBox="0 0 520 320" xmlns="http://www.w3.org/2000/svg"><rect x="1" y="1" width="518" height="318" rx="16" fill="#fff" stroke="#e7d9bd"/>${inner}</svg>`;}
                    function label(x,y,t,a='middle'){return `<text x="${x}" y="${y}" font-family="system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial" font-size="15" fill="#333" text-anchor="${a}">${t}</text>`;}
                    function render(opt){
                      let svg="";
                      switch(opt){
                        case "Mutually inclusive": {const cx=260,cy=160,r=110; svg=svgWrap(`<circle cx="${cx}" cy="${cy}" r="${r}" fill="#FCE9B3" stroke="#E7C56A"/>${label(cx,cy-85, A+" = "+B)}${label(260,300,"All and only the same members")}`); break;}
                        case "Mutually exclusive": {const r=95,cy=165,l=170,rX=350,g=12; svg=svgWrap(`<circle cx="${l}" cy="${cy}" r="${r}" fill="#FFE2A0" stroke="#E7C56A"/><circle cx="${rX+g}" cy="${cy}" r="${r}" fill="#F6A9A6" stroke="#E7A4A0"/>${label(l,cy,A)}${label(rX+g,cy,B)}${label(260,300,"No overlap")}`); break;}
                        case "3 possibilities (down)": {const cx=260,cy=165,R=120,r=72; svg=svgWrap(`<circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="#E7A4A0" stroke-width="2"/><circle cx="${cx}" cy="${cy}" r="${r}" fill="#FFE2A0" stroke="#E7C56A"/>${label(cx,cy-90,B)}${label(cx,cy,A)}${label(260,300, A+" ⊂ "+B)}`); break;}
                        case "3 possibilities (up)": {const cx=260,cy=165,R=120,r=72; svg=svgWrap(`<circle cx="${cx}" cy="${cy}" r="${R}" fill="none" stroke="#E7C56A" stroke-width="2"/><circle cx="${cx}" cy="${cy}" r="${r}" fill="#F6A9A6" stroke="#E7A4A0"/>${label(cx,cy-90,A)}${label(cx,cy,B)}${label(260,300, B+" ⊂ "+A)}`); break;}
                        case "4 possibilities": {const cy=165,r=95,l=220,rX=300; const lf="#FFE2A0", rf="#F6A9A6", ov="#EFCF95"; svg=svgWrap(`<defs><clipPath id="left-bottom"><circle cx="${l}" cy="${cy}" r="${r}"/></clipPath></defs><circle cx="${l}" cy="${cy}" r="${r}" fill="${lf}" stroke="#E7C56A"/><circle cx="${rX}" cy="${cy}" r="${r}" fill="${rf}" stroke="#E7A4A0"/><g clip-path="url(#left-bottom)"><circle cx="${rX}" cy="${cy}" r="${r}" fill="${ov}"/></g>${label(l-48,cy,A)}${label(rX+48,cy,B)}${label(260,300,"Partial overlap")}`); break;}
                        default: svg=svgWrap(`<text x="260" y="170" font-size="14" fill="#7b6a55" text-anchor="middle">Pick an option to preview…</text>`);
                      }
                      box.innerHTML = svg;
                    }
                    if (sel){ sel.addEventListener('change', e=>render(e.target.value)); render(sel.value); }
                  })();
                </script>
              {% endif %}

              {% if turn_state.mode == 'tsar_decide' %}
                <select class="select-inline" name="contradiction_choice_{{ i }}">
                  <option value="">-- choose --</option>
                  {% for opt in step.contradiction_options %}
                    <option value="{{ opt }}" {% if step.contradiction_choice == opt %}selected{% endif %}>{{ opt }}</option>
                  {% endfor %}
                </select>
              {% else %}
                {% if step.tsar_called == '1' and step.contradiction_choice %}
                  <input type="hidden" name="contradiction_choice_{{ i }}" value="{{ step.contradiction_choice }}">
                {% endif %}
              {% endif %}

              {% if turn_state.mode == 'challenger_menu' %}
                <select class="select-inline" name="challenger_choice_{{ i }}">
                  <option value="">-- choose --</option>
                  {% for opt in step.challenger_options %}
                    <option value="{{ opt }}" {% if step.challenger_choice == opt %}selected{% endif %}>{{ opt }}</option>
                  {% endfor %}
                </select>
                {% if step.challenger_choice
                      and step.challenger_choice not in ['Ask a question','Compare phenomena','Tsar! [You contradicted yourself!]','Write a new consequence'] %}
                  <input type="text" name="challenger_reason_{{ i }}" value="{{ step.challenger_reason }}" placeholder="because of being …" style="min-width:320px" />
                {% endif %}
              {% endif %}

              <button class="btn btn-primary" type="submit" name="submit_continue">Submit / Continue</button>

              <!-- Utilities -->
              <button class="btn btn-ghost" type="submit" name="switch_roles">Switch roles</button>
              <button class="btn btn-ghost" type="submit" name="generate_transcript">Generate Transcript</button>
            </div>
          </div>
        </div>
      {% endif %}
    </form>
  </div>

  <script>
    // Preserve scroll position across postbacks
    (function(){
      const KEY = "debate-scrollY";
      try{
        const y = parseInt(localStorage.getItem(KEY), 10);
        if (!isNaN(y)) { window.scrollTo(0, y); }
      }catch(e){}
      window.addEventListener('beforeunload', function(){
        try{ localStorage.setItem(KEY, String(window.scrollY)); }catch(e){}
      });
    })();

    // Transcript copy + toast (if transcript is present)
    function copyTranscript(){
      const el = document.getElementById('transcriptText');
      if(!el) return;
      const text = el.innerText || el.textContent || "";
      const toast = document.getElementById('toast');
      function showToast(){ toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1400); }
      if (navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(showToast).catch(fallback);
      } else { fallback(); }
      function fallback(){
        const range=document.createRange(), sel=window.getSelection();
        range.selectNodeContents(el); sel.removeAllRanges(); sel.addRange(range);
        try{ document.execCommand('copy'); }catch(e){}
        sel.removeAllRanges(); showToast();
      }
    }
  </script>
</body>
</html>
